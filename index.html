<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Church Finance Dashboard</title>

<style>
/* ===== GENERAL ===== */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f4f4;
}

h2, h3 {
    text-align: center;
    margin: 5px 0;
}

.header {
    background: #2c3e50;
    color: #fff;
    padding: 15px;
    text-align: center;
}

.nav {
    display: flex;
    background: #34495e;
}

.nav button {
    flex: 1;
    padding: 12px;
    border: none;
    background: #34495e;
    color: white;
    font-size: 15px;
    cursor: pointer;
}

.nav button.active {
    background: #1abc9c;
    font-weight: bold;
}

.content {
    background: white;
    padding: 20px;
    min-height: 100vh;
}

.page {
    display: none;
}

.page.active {
    display: block;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

table, th, td {
    border: 1px solid #000;
}

th, td {
    padding: 6px;
    text-align: right;
}

th {
    background: #eee;
}

td:first-child, th:first-child {
    text-align: left;
}

input, select {
    width: 100%;
    border: none;
    border-bottom: 1px solid #000;
    padding: 4px;
}

input[readonly] {
    background: #f0f0f0;
}

button {
    margin-top: 6px;
    padding: 6px 10px;
}

/* PRINT */

.print-bar {
    text-align: right;
    margin-bottom: 10px;
}

@media print {
    .nav,
    .print-bar,
    button {
        display: none !important;
    }

}
.backup-bar {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-bottom: 1px solid #ccc;
}

.restore-btn {
    background: #e67e22;
    color: #fff;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 3px;
}

.backup-bar button {
    background: #27ae60;
    color: #fff;
    border: none;
    padding: 6px 10px;
    cursor: pointer;
}

@media print {
    .backup-bar {
        display: none !important;
    }
}
.backup-bar {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-bottom: 1px solid #ccc;
}

.backup-bar button {
    padding: 6px 10px;
    cursor: pointer;
}

@media print {
    .backup-bar {
        display: none !important;
    }
}


</style>
</head>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<body>

<div class="header">
    <h2>BLESSED HOUSE OF WORSHIP INTERNATIONAL INC.</h2>
    <p>Cagayan‚ÄìApayao District ¬∑ Finance Dashboard</p>
</div>

<div class="backup-bar">
    <button id="googleSignInBtn">üîê Sign in with Google</button>
    <button onclick="backupToDrive()" disabled id="backupBtn">‚òÅÔ∏è Backup to Drive</button>
    <button onclick="restoreFromDrive()" disabled id="restoreBtn">‚ôªÔ∏è Restore from Drive</button>
</div>

<div class="backup-bar">
    <button onclick="backupData()">üíæ Backup Data</button>

    <label class="restore-btn">
        ‚ôªÔ∏è Restore Data
        <input type="file" accept=".json" onchange="restoreData(event)" hidden>
    </label>
</div>

<div class="nav">
    <button class="active" onclick="showPage('monthly', this)">Monthly</button>
    <button onclick="showPage('yearly', this)">Yearly Summary</button>
    <button onclick="showPage('area', this)">Area Yearly</button>
</div>

<div class="content">

<!-- ================= MONTHLY ================= -->
<div id="monthly" class="page active">
	<div class="print-bar">
    <button onclick="printPage('monthly')">üñ®Ô∏è Print</button>
</div>


<h3>District Monthly Report</h3>

<label>Month:</label>
<select id="monthlyMonth"></select>

<label>Year:</label>
<input type="number" id="monthlyYear" value="2025">

<table>
<thead>
<tr><th>Area</th><th>10%</th></tr>
</thead>
<tbody id="monthlyCollectionBody"></tbody>
<tfoot>
<tr>
    <td><strong>Total</strong></td>
    <td><input id="monthlyCollectionTotal" readonly></td>
</tr>
</tfoot>
</table>

<button onclick="addMonthlyArea()">‚ûï Add Area</button>

<h3>Expenses</h3>

<table>
<thead>
<tr><th>Description</th><th>Amount</th></tr>
</thead>
<tbody id="monthlyExpenseBody"></tbody>
<tfoot>
<tr>
    <td><strong>Total</strong></td>
    <td><input id="monthlyExpenseTotal" readonly></td>
</tr>
</tfoot>
</table>

<button onclick="addMonthlyExpense()">‚ûï Add Expense</button>

<p><strong>Remaining Balance:</strong>
<input id="monthlyBalance" readonly></p>

</div>

<!-- ================= YEARLY ================= -->
<div id="yearly" class="page">
	<div class="print-bar">
    <button onclick="printPage('monthly')">üñ®Ô∏è Print</button>
</div>


<h3>Yearly Financial Summary</h3>

<label>Year:</label>
<select id="yearlyYear"></select>

<table id="yearlyTable"></table>

</div>

<!-- ================= AREA ================= -->
<div id="area" class="page">
	<div class="print-bar">
    <button onclick="printPage('monthly')">üñ®Ô∏è Print</button>
</div>


<h3>Local Church Yearly Report</h3>

<label>Year:</label>
<select id="areaYear"></select>

<label>Area:</label>
<select id="areaName"></select>

<table id="areaTable"></table>

</div>

</div>

<script>
/* ========== NAV ========== */
function showPage(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

/* ========== CONSTANTS ========== */
const MONTHS = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
];

/* ========== MONTHLY ========== */
const mMonth = document.getElementById('monthlyMonth');
const mYear = document.getElementById('monthlyYear');
const mColBody = document.getElementById('monthlyCollectionBody');
const mExpBody = document.getElementById('monthlyExpenseBody');

const mColTotal = document.getElementById('monthlyCollectionTotal');
const mExpTotal = document.getElementById('monthlyExpenseTotal');
const mBalance = document.getElementById('monthlyBalance');

MONTHS.forEach(m => mMonth.add(new Option(m, m)));

let mAreaCount = 0;
let mExpCount = 0;
let mKey = "";

function monthlyKey() {
    return `report-${mMonth.value}-${mYear.value}`;
}

function resetMonthly() {
    mColBody.innerHTML = "";
    mExpBody.innerHTML = "";
    mAreaCount = 0;
    mExpCount = 0;
    calcMonthly();
}

function addMonthlyArea(save = true) {
    mAreaCount++;
    const r = document.createElement('tr');
    r.innerHTML = `
        <td><input data-k="area${mAreaCount}-name"></td>
        <td><input type="number" class="mcol" data-k="area${mAreaCount}"></td>
    `;
    mColBody.appendChild(r);
    if (save) saveMonthly();
}

function addMonthlyExpense(save = true) {
    mExpCount++;
    const r = document.createElement('tr');
    r.innerHTML = `
        <td><input data-k="exp${mExpCount}-name"></td>
        <td><input type="number" class="mexp" data-k="exp${mExpCount}"></td>
    `;
    mExpBody.appendChild(r);
    if (save) saveMonthly();
}

function calcMonthly() {
    let c = 0, e = 0;
    document.querySelectorAll('.mcol').forEach(i => c += +i.value || 0);
    document.querySelectorAll('.mexp').forEach(i => e += Math.abs(+i.value || 0));
    mColTotal.value = c.toLocaleString();
    mExpTotal.value = e.toLocaleString();
    mBalance.value = (c - e).toLocaleString();
}

function saveMonthly() {
    if (!mKey) return;
    const data = { areaCount: mAreaCount, expenseCount: mExpCount, fields: {} };
    document.querySelectorAll('[data-k]').forEach(i => data.fields[i.dataset.k] = i.value);
    localStorage.setItem(mKey, JSON.stringify(data));
}

function loadMonthly() {
    resetMonthly();
    mKey = monthlyKey();
    const d = JSON.parse(localStorage.getItem(mKey));
    if (!d) return;
    for (let i = 0; i < d.areaCount; i++) addMonthlyArea(false);
    for (let i = 0; i < d.expenseCount; i++) addMonthlyExpense(false);
    document.querySelectorAll('[data-k]').forEach(i => i.value = d.fields[i.dataset.k] || "");
    calcMonthly();
}

document.addEventListener('input', () => {
    calcMonthly();
    saveMonthly();
});

mMonth.onchange = () => { saveMonthly(); loadMonthly(); };
mYear.onchange = mMonth.onchange;

mKey = monthlyKey();
loadMonthly();

/* ========== YEARLY SUMMARY ========== */
const yYear = document.getElementById('yearlyYear');
const yTable = document.getElementById('yearlyTable');

for (let y = 2024; y <= 2027; y++) yYear.add(new Option(y, y));

function buildYearly() {
    const areas = new Set();

    MONTHS.forEach(m => {
        const d = JSON.parse(localStorage.getItem(`report-${m}-${yYear.value}`));
        if (d) Object.keys(d.fields).forEach(k => {
            if (k.endsWith('-name') && d.fields[k]) areas.add(d.fields[k]);
        });
    });

    const A = [...areas];
    let html = `<tr><th>Month</th>${A.map(a => `<th>${a}</th>`).join("")}</tr>`;

    MONTHS.forEach(m => {
        const d = JSON.parse(localStorage.getItem(`report-${m}-${yYear.value}`)) || {};
        let row = `<tr><td>${m}</td>`;
        A.forEach(a => {
            let v = 0;
            Object.keys(d.fields || {}).forEach(k => {
                if (d.fields[k] === a) v = +d.fields[k.replace('-name','')] || 0;
            });
            row += `<td>${v ? v.toLocaleString() : ""}</td>`;
        });
        row += `</tr>`;
        html += row;
    });

    yTable.innerHTML = html;
}

yYear.onchange = buildYearly;
buildYearly();

/* ========== AREA YEARLY ========== */
const aYear = document.getElementById('areaYear');
const aName = document.getElementById('areaName');
const aTable = document.getElementById('areaTable');

for (let y = 2024; y <= 2027; y++) aYear.add(new Option(y, y));

function loadAreaNames() {
    aName.innerHTML = "";
    const set = new Set();
    MONTHS.forEach(m => {
        const d = JSON.parse(localStorage.getItem(`report-${m}-${aYear.value}`));
        if (d) Object.keys(d.fields).forEach(k => {
            if (k.endsWith('-name') && d.fields[k]) set.add(d.fields[k]);
        });
    });
    set.forEach(a => aName.add(new Option(a, a)));
}

function buildArea() {
    let total = 0;
    let html = `<tr><th>Month</th><th>${aName.value}</th></tr>`;
    MONTHS.forEach(m => {
        const d = JSON.parse(localStorage.getItem(`report-${m}-${aYear.value}`)) || {};
        let v = 0;
        Object.keys(d.fields || {}).forEach(k => {
            if (d.fields[k] === aName.value) v = +d.fields[k.replace('-name','')] || 0;
        });
        total += v;
        html += `<tr><td>${m}</td><td>${v ? v.toLocaleString() : ""}</td></tr>`;
    });
    html += `<tr><th>Total</th><th>${total.toLocaleString()}</th></tr>`;
    aTable.innerHTML = html;
}

aYear.onchange = () => { loadAreaNames(); buildArea(); };
aName.onchange = buildArea;

loadAreaNames();
buildArea();
</script>
<script>
function printPage(pageId) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(p => {
        p.style.display = 'none';
    });

    // Show only selected page
    const page = document.getElementById(pageId);
    page.style.display = 'block';

    // Print
    window.print();

    // Restore visibility
    document.querySelectorAll('.page').forEach(p => {
        p.style.display = '';
    });
}
</script>

<script>
const CLIENT_ID = "YOUR_CLIENT_ID_HERE";
const SCOPES = "https://www.googleapis.com/auth/drive.appdata";

let accessToken = null;

/* ---------- SIGN IN ---------- */
document.getElementById("googleSignInBtn").onclick = () => {
    google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: t => {
            accessToken = t.access_token;
            alert("Signed in with Google");
            backupBtn.disabled = false;
            restoreBtn.disabled = false;
        }
    }).requestAccessToken();
};

/* ---------- GET BACKUP FILE ID ---------- */
async function getBackupFileId() {
    const res = await fetch(
        "https://www.googleapis.com/drive/v3/files?q=name='church-finance-backup.json'&spaces=appDataFolder",
        { headers: { Authorization: "Bearer " + accessToken } }
    );
    const data = await res.json();
    return data.files?.[0]?.id || null;
}

/* ---------- BACKUP ---------- */
async function backupToDrive() {
    if (!accessToken) return alert("Sign in first");

    const backup = {};
    for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k.startsWith("report-")) {
            backup[k] = localStorage.getItem(k);
        }
    }

    const fileId = await getBackupFileId();
    const method = fileId ? "PATCH" : "POST";
    const url = fileId
        ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`
        : "https://www.googleapis.com/upload/drive/v3/files?uploadType=media";

    const metaUrl = fileId
        ? null
        : "https://www.googleapis.com/drive/v3/files";

    if (!fileId) {
        await fetch(metaUrl, {
            method: "POST",
            headers: {
                Authorization: "Bearer " + accessToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                name: "church-finance-backup.json",
                parents: ["appDataFolder"]
            })
        });
    }

    await fetch(url, {
        method,
        headers: {
            Authorization: "Bearer " + accessToken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(backup)
    });

    alert("Backup successfully saved to Google Drive");
}

/* ---------- RESTORE ---------- */
async function restoreFromDrive() {
    if (!accessToken) return alert("Sign in first");

    const fileId = await getBackupFileId();
    if (!fileId) return alert("No backup found in Drive");

    if (!confirm("This will overwrite current data. Continue?")) return;

    const res = await fetch(
        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
        { headers: { Authorization: "Bearer " + accessToken } }
    );
    const data = await res.json();

    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
    alert("Restore complete. Reloading‚Ä¶");
    location.reload();
}
</script>


</body>
</html>

